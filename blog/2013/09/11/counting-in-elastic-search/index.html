<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><meta name="author" content="OpenTable"><link rel="icon" href="/favicon.png"><title>OpenTable Tech UK Blog</title><meta name="description"><link rel="alternate" type="application/rss+xml" title="OpenTable Tech UK Blog" href="/atom.xml"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/main.css"><script src="//fonts.otstatic.com/zys4lfz.js"></script><link rel="stylesheet" href="/css/highlight.css">
</head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target="#main-navbar" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">OpenTable Tech UK Blog</a></div><div id="main-navbar" class="collapse navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/about/">About</a></li><li><a href="/archives/">Archive</a></li><li><a href="/blog/authors/">Authors</a></li></ul></div><div class="avatar-container"><div class="avatar-img-border"><a href="/"><img src="/opentable.png" class="avatar-img"></a></div></div></div></nav><header class="header-section"><div class="intro-header no-img"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><h1>Counting in ElasticSearch</h1><p class="post-meta">Posted by <a href="/blog/authors/mbazydlo.html">mbazydlo</a>, 11 September 2013 · <a href="/blog/categories/ElasticSearch/" class="tag post-meta">ElasticSearch</a> · <a href="/blog/categories/Count/" class="tag post-meta">Count</a> · <a href="/blog/categories/Search/" class="tag post-meta">Search</a> · <a href="/blog/categories/PlainElastic-Net/" class="tag post-meta">PlainElastic.Net</a></p></div></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role="main" class="blog-post"><blockquote>
<p>Counting is the religion of this generation it is its hope and its salvation.<br>Gertrude Stein</p>
</blockquote>
<p>In our NeverEnding quest to provide better experience to the users we utilise user behaviour logs to influence future results. One particular case is restaurant popularity, which is indicated by many factors, for example how often it is searched and viewed.</p>
<p>In this blog post we will look into multiple ways of counting documents in Elastic Search which is crucial for this kind of activity. All examples here are provided using Elastic Search HTTP interface and code examples implemented with <a href="https://github.com/Yegoroff/PlainElastic.Net" target="_blank" rel="noopener">PlainElastic.NET</a> are <a href="https://gist.github.com/gondar/6320578" target="_blank" rel="noopener">available here</a></p>
<p>Before we make a deep dive into Elastic Search Counting options let’s define our expectations:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">So that I can order restaurants by those that are most searched</span><br><span class="line">As a potential diner</span><br><span class="line">I want the most searched statistics from the logs to be part of the search database</span><br></pre></td></tr></table></figure></p>
<p>Okay, that’s not exactly how our story was defined but as we don’t want to discuss the whole search infrastructure here, let’s assume this is sufficient.</p>
<p>Because we are eager engineers, we will quickly build some mock data against which to test our assumptions. Our restaurant name search logs look something like this:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;RestaurantId&quot; : 2,</span><br><span class="line">	&quot;RestaurantName&quot; : &quot;Restaurant Brian&quot;,</span><br><span class="line">	&quot;DateTime&quot; : &quot;2013-08-16T15:13:47.4833748+01:00&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>So we will populate our mock database with appropriate commands and check that all is in place:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9200/store/item/ -XPOST -d &apos;&#123;&quot;RestaurantId&quot;:2,&quot;RestaurantName&quot;:&quot;Restaurant Brian&quot;,&quot;DateTime&quot;:&quot;2013-08-16T15:13:47.4833748+01:00&quot;&#125;&apos;</span><br><span class="line">curl http://localhost:9200/store/item/ -XPOST -d &apos;&#123;&quot;RestaurantId&quot;:1,&quot;RestaurantName&quot;:&quot;Restaurant Cecil&quot;,&quot;DateTime&quot;:&quot;2013-08-16T15:13:47.4833748+01:00&quot;&#125;&apos;</span><br><span class="line">curl http://localhost:9200/store/item/ -XPOST -d &apos;&#123;&quot;RestaurantId&quot;:1,&quot;RestaurantName&quot;:&quot;Restaurant Cecil&quot;,&quot;DateTime&quot;:&quot;2013-08-16T15:13:47.4833748+01:00&quot;&#125;&apos;</span><br><span class="line">curl http://localhost:9200/store/item/_search?q=*\&amp;pretty</span><br></pre></td></tr></table></figure></p>
<p>Our expected output is a count of documents for each restaurant. For example:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;Restaurant Brian&quot; : 1</span><br><span class="line">	&quot;Restaurant Cecil&quot; : 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>There are three ways this can be achieved in Elastic Search; using count API (which seems like the most obvious way), a search with type set to count, or using facets to generate counts of all objects grouped by given property. Let’s compare them:</p>
<h3 id="Count-API"><a href="#Count-API" class="headerlink" title="Count API"></a>Count API</h3><p>(<a href="http://www.elasticsearch.org/guide/reference/api/count/" target="_blank" rel="noopener">See documentation here</a>)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST http://localhost:9200/store/item/_count -d &apos;&#123;</span><br><span class="line">	&quot;field&quot;: &#123;</span><br><span class="line">		&quot;RestaurantName&quot;: &#123;</span><br><span class="line">			&quot;query&quot;: &quot;Restaurant Cecil&quot;,</span><br><span class="line">			&quot;default_operator&quot;: &quot;AND&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;&apos;</span><br><span class="line">&#123;</span><br><span class="line">	&quot;count&quot;:2,</span><br><span class="line">	&quot;_shards&quot;:&#123;&quot;total&quot;:5,&quot;successful&quot;:5,&quot;failed&quot;:0&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Count is nice little feature which solves our problem. However, if we need count for multiple restaurants we need to execute similar queries multiple times, which may hugely influence both performance of our query and usage of our ElasticSeach cluster.</p>
<h3 id="Search"><a href="#Search" class="headerlink" title="Search"></a>Search</h3><p>(<a href="http://www.elasticsearch.org/guide/reference/api/search/search-type/" target="_blank" rel="noopener">See documentation here</a>)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST http://localhost:9200/store/item/_search?search_type=count -d &apos; &#123;</span><br><span class="line">	&quot;query&quot;: &#123;</span><br><span class="line">		&quot;field&quot;: &#123;</span><br><span class="line">			&quot;RestaurantName&quot;: &#123;</span><br><span class="line">				&quot;query&quot;: &quot;Restaurant Cecil&quot;,</span><br><span class="line">				&quot;default_operator&quot;: &quot;AND&quot;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;&apos;</span><br><span class="line">&#123;</span><br><span class="line">	&quot;took&quot;:5,&quot;timed_out&quot;:false,&quot;_shards&quot;:&#123;&quot;total&quot;:5,&quot;successful&quot;:5,&quot;failed&quot;:0&#125;,</span><br><span class="line">	&quot;hits&quot;: &#123;</span><br><span class="line">		&quot;total&quot;: 2,</span><br><span class="line">		&quot;max_score&quot;: 0.0,</span><br><span class="line">		&quot;hits&quot;:[]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Using search type set to count is the same as executing a search request with size set to zero, but it’s internally optimised for performance. The nice thing about search is that we can use multi_search interface to execute many count queries at once.</p>
<p>On the other hand, the query still will be executed multiple times, so it is only feasible if we want to get popularity for a small subset of all the restaurants we have.</p>
<p>Comparing two previous requests highlights that the query language is slightly different. The DSL for <em>count API</em> is basically the same as for the <em>search API</em>, but you are immediately inside the ‘query’ part. That inconsistency on the ElasticSearch side is only a minor inconvenience.</p>
<h3 id="Facets"><a href="#Facets" class="headerlink" title="Facets"></a>Facets</h3><p>(<a href="http://www.elasticsearch.org/guide/reference/api/search/facets/" target="_blank" rel="noopener">See documentation here</a>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST http://localhost:9200/store/item/_search?search_type=count -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;: &#123;</span><br><span class="line">		&quot;match_all&quot;: &#123;</span><br><span class="line">			 </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;facets&quot;: &#123;</span><br><span class="line">		&quot;ItemsPerCategoryCount&quot;: &#123;</span><br><span class="line">			&quot;terms&quot;: &#123;</span><br><span class="line">				&quot;field&quot;: &quot;RestaurantId&quot;,</span><br><span class="line">				&quot;size&quot;: 100</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;&apos;</span><br><span class="line">&#123;</span><br><span class="line">	&quot;took&quot;:1,&quot;timed_out&quot;:false,&quot;_shards&quot;:&#123;&quot;total&quot;:5,&quot;successful&quot;:5,&quot;failed&quot;:0&#125;,&quot;hits&quot;:&#123;&quot;total&quot;:132,&quot;max_score&quot;:0.0,&quot;hits&quot;:[]&#125;,</span><br><span class="line">	&quot;facets&quot;: &#123;</span><br><span class="line">		&quot;ItemsPerCategoryCount&quot;: &#123;</span><br><span class="line">			&quot;_type&quot;: &quot;terms&quot;,</span><br><span class="line">			&quot;missing&quot;:0,</span><br><span class="line">			&quot;total&quot;:3,</span><br><span class="line">			&quot;other&quot;:0,</span><br><span class="line">			&quot;terms&quot;: [</span><br><span class="line">				&#123;&quot;term&quot;: 2, &quot;count&quot;: 1&#125;,</span><br><span class="line">				&#123;&quot;term&quot;: 1, &quot;count&quot;:2&#125;</span><br><span class="line">			]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Facets is a means to obtain grouping by a given field together with count in a group. It is designed to ease creation of filters which are often naturally part of search results interface.</p>
<p>This is nice feature which grabs for us all counts grouped by given field. That’s more then we need if we only care for a count of single type, but it’s invaluable if you want to have counts for all terms in a field. Also note that we are using search type count again, but facets work equally well for all types of searches including those which actually return results.</p>
<p>In the example above we used ‘RestaurantId’ field instead of restaurant name, as this field is not analysed. If we used restaurant name it would give us facets for each term e.g. [{“term”: “Restaurant”, “count”: 3}, {“term”:”Cecil”, “count”:2},{“term”:”Brian”, “count”:1}], which is not what we exactly want.</p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>It’s hard to discuss which one is better. Count API is slightly faster then Search of type count. On the other hand search is more flexible, and its queries are consistent with normal search queries. Facets is a different beast altogether as it always grabs all the results. Still, it’s fun that ElasticSearch is elastic in this aspect giving us variety of approaches.</p>
<p>We are really curious about your experiences in ElasticSearch. If you have any questions, proposals or comments feel free to <a href="mailto:mbazydlo@opentable.com" target="_blank" rel="noopener">email me</a>.</p>
<h3 id="Acknowledgement"><a href="#Acknowledgement" class="headerlink" title="Acknowledgement"></a>Acknowledgement</h3><p>This blog post benefited thanks to invaluable comments from my team (Andrew Metcalfe, Michael Wallett and Tom Harvey), <a href="https://github.com/Yegoroff/PlainElastic.Net" target="_blank" rel="noopener">PlainElastic.Net</a> author (Yegoroff) and <a href="https://github.com/pbazydlo" target="_blank" rel="noopener">my brother</a>.</p>
</article><ul class="pager blog-pager"><li class="previous"><a href="/blog/2013/09/23/quick-look-at-rethinkdb/" data-toggle="tooltip" data-placement="top" title="Quick look at RethinkDB">← Previous Post</a></li><li class="next"><a href="/blog/2013/08/16/grunt-plus-vagrant-equals-acceptance-test-heaven/" data-toggle="tooltip" data-placement="top" title="Grunt + Vagrant = Acceptance Test Heaven">Next Post →</a></li></ul></div></div></div><footer><div class="container beautiful-jekyll-footer"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href="https://github.com/opentable" title="GitHub"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-github"></i></span></a></li><li><a href="https://twitter.com/opentabletechuk" title="Twitter"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-twitter"></i></span></a></li><li><a href="https://www.linkedin.com/company/12181" title="LinkedIn"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-linkedin"></i></span></a></li><li><a href="http://stackoverflow.com/jobs/companies/opentable" title="StackOverflow"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-stack-overflow"></i></span></a></li></ul><p class="copyright text-muted">© OpenTable • 2022 • <a href="mailto:undefined"></a>
</p><p class="theme-by text-muted">Theme by
<a href="https://github.com/twoyao/beautiful-hexo">beautiful-hexo</a></p></div></div></div></footer><script src="/js/jquery-1.11.2.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/main.js"></script><script src="/js/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script>(function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
    a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
})(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-2621903-16', 'auto');
ga('send', 'pageview');</script></body></html>