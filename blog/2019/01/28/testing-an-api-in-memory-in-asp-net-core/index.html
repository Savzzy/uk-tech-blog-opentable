<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><meta name="author" content="OpenTable"><link rel="icon" href="/favicon.png"><title>OpenTable Tech UK Blog</title><meta name="description"><link rel="alternate" type="application/rss+xml" title="OpenTable Tech UK Blog" href="/atom.xml"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/main.css"><script src="//fonts.otstatic.com/zys4lfz.js"></script><link rel="stylesheet" href="/css/highlight.css">
</head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target="#main-navbar" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">OpenTable Tech UK Blog</a></div><div id="main-navbar" class="collapse navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/about/">About</a></li><li><a href="/archives/">Archive</a></li><li><a href="/blog/authors/">Authors</a></li></ul></div><div class="avatar-container"><div class="avatar-img-border"><a href="/"><img src="/opentable.png" class="avatar-img"></a></div></div></div></nav><header class="header-section"><div class="intro-header no-img"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><h1>Testing an API In Memory in ASP.NET Core</h1><p class="post-meta">Posted by <a href="/blog/authors/dgiddins.html">dgiddins</a>, 28 January 2019 · <a href="/blog/categories/Testing/" class="tag post-meta">Testing</a> · <a href="/blog/categories/DotNetCore/" class="tag post-meta">DotNetCore</a> · <a href="/blog/categories/ASP-Net/" class="tag post-meta">ASP.Net</a> · <a href="/blog/categories/NUnit/" class="tag post-meta">NUnit</a></p></div></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role="main" class="blog-post"><h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>This is long post that describes how to setup an in-memory test harness for testing an entire ASP.NET Core API with lots of code examples. </p>
<h2 id="Testing-and-broccoli"><a href="#Testing-and-broccoli" class="headerlink" title="Testing and broccoli"></a>Testing and broccoli</h2><p>Unit testing, like broccoli, is something we all know we should do, but actually we just want to tuck into the meat and potatoes of production code. One reason you might resist writing unit tests is that you are writing an API which is mostly a CRUD layer over a database (where most of the code is right-to-left copying from a DTO to an API response), or you are writing framework plugins for which you just can’t write meaningful tests (for instance ActionFilters or Binder). </p>
<p>Well I understand, I’ve been in the same situation, but I have a way of dealing with this problem. What I prefer to do is test at the level of http all the way through the API to the database. But wait, you may cry, that’s not a unit test! Well yes you have a point there, I’m touching lots of different classes when I test like this. I would argue however that the word “unit” is a bit ambiguous; my definition of unit is not ‘a single class’. </p>
<p>I prefer to classify tests as either <strong>Isolated</strong>, <strong>Integration</strong>, or <strong>End-to-End</strong>. When I say isolated, what I mean is that the test can be run without worrying about external dependencies, whether they are your databases or an external API or other system. This means you can test anything from a single class up to the whole API, reliably and repeatably. Integration tests then focus on integrations with your database, external APIs etc. These tests are simple and limited in scope so when they break your integration code is broken or the system is down. End-to-End tests end up being more akin to smoke tests or sanity tests and any break in these should be reflected in your Isolated and Integration tests. </p>
<p>Given these definitions let’s look at how you can test your API end-to-end in an isolated fashion. Or put another way, let’s cook that broccoli in butter and chilli and season with salt, pepper and a little grated parmesan (you’re welcome!)</p>
<p>In order to test an ASP.NET Core application we need to be able to spin up our whole application in a test harness (i.e. your unit test/test fixture). Microsoft provide a NuGet package that lets us do just that; <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.TestHost/" target="_blank" rel="noopener">Microsoft.AspNetCore.TestHost</a> contains a class called TestServer. Once you create an instance of the TestServer you can get an instance of a HttpClient with which you can then make http calls to your API. </p>
<h2 id="Creating-a-TestServer-instance"><a href="#Creating-a-TestServer-instance" class="headerlink" title="Creating a TestServer instance"></a>Creating a TestServer instance</h2><p>To create an instance of the TestServer you need to supply its constructor with an instance of a WebHostBuilder. The easiest way to create a WebHostBuilder is in the same manner as you would when you are building your IWebHost implementation to run your site with Kestrel.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        BuildWebHost(args).Run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IWebHost <span class="title">BuildWebHost</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WebHostBuilder().UseKestrel()</span><br><span class="line">            .UseContentRoot(Directory.GetCurrentDirectory())</span><br><span class="line">            .UseStartup&lt;Startup&gt;()</span><br><span class="line">            .UseUrls(<span class="string">"http://*:"</span> + ApplicationInfoProvider.GetPort())</span><br><span class="line">            .Build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>So in a test harness you would write</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> webHostBuilder = <span class="keyword">new</span> WebHostBuilder().UseStartUp&lt;Startup&gt;());</span><br><span class="line"><span class="keyword">var</span> server = <span class="keyword">new</span> TestServer(webHostBuilder);</span><br><span class="line"><span class="keyword">var</span> httpClient = server.CreateClient();</span><br></pre></td></tr></table></figure>
<p>The problem with this is if you just use your Startup class that you use for normally spinning up your site, you end up with the exact same configuration and therefore the same dependencies. You may think to create a new version of Startup (InMemoryStartup for instance) and reference that; the problem then is that you don’t have an easy way to manipulate the state of your API from your test harness, unless you want to use static properties. That might work in simple cases, but with complex systems managing that static state might become problematic - and who likes statics anyway. </p>
<p>What we really want to do is pass on instance of a Startup class (designed for in-memory testing) to the WebHostBuilder constructor, but there is no native support for this. To get around this use the following extension method.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">WebHostBuilderExtensions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IWebHostBuilder <span class="title">UseStartupInstance</span>(<span class="params"><span class="keyword">this</span> IWebHostBuilder hostBuilder, IStartup startup</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">string</span> name = startup.GetType().GetTypeInfo().Assembly.GetName().Name;</span><br><span class="line">        <span class="keyword">return</span> hostBuilder.UseSetting(WebHostDefaults.ApplicationKey, name).ConfigureServices((services =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span>(IStartup).GetTypeInfo().IsAssignableFrom(startup.GetType().GetTypeInfo()))</span><br><span class="line">                services.AddSingleton(startup);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                services.AddSingleton(<span class="keyword">typeof</span>(IStartup), serviceProvider =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    IHostingEnvironment requiredService = serviceProvider.GetRequiredService&lt;IHostingEnvironment&gt;();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> ConventionBasedStartup(StartupLoader.LoadMethods(serviceProvider, startup.GetType(), requiredService.EnvironmentName));</span><br><span class="line">                &#125;);</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>As an aside, this post <a href="https://www.stevejgordon.co.uk/aspnet-core-anatomy-how-does-usestartup-work" target="_blank" rel="noopener">https://www.stevejgordon.co.uk/aspnet-core-anatomy-how-does-usestartup-work</a> is a very in depth look at how Startup classes work in Asp.net.</p>
</blockquote>
<p>You might have noticed the IStartUp type in the UseStartupInstance above and be thinking, wait, my Startup class doesn’t implement that, what’s going on? Well, it’s basically some convention-based magic which is explained and examined in the blog post I reference above. It’s the kind of thing that personally irritates me as it makes things less discoverable for the sake of not writing <code>&quot; : IStartup&quot;</code> for each project (This isn’t really why its done but thats what it feels like). </p>
<p>We can now inject a Startup class as shown below.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> webHostBuilder = <span class="keyword">new</span> WebHostBuilder().UseStartupInstance(<span class="keyword">new</span> Startup());</span><br><span class="line"><span class="keyword">var</span> server = <span class="keyword">new</span> TestServer(webHostBuilder);</span><br><span class="line"><span class="keyword">var</span> httpClient = server.CreateClient();</span><br></pre></td></tr></table></figure>
<p>But now this won’t work because your normal Startup class does not implement IStartup, therefore we need to create an InMemoryStartup class that does implement this, and which we can customize for testing purposes. This would look something like the following.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">InMemoryStartup</span> : <span class="title">IStartup</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InMemoryStartup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IServiceProvider <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Some code to configure services</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Some code to configure application</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You would then construct your test harness as follows (if you are using NUnit)</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[<span class="meta">TextFixture</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SomeInMemoryTests</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> HttpClient _httpClient;</span><br><span class="line"></span><br><span class="line">  [<span class="meta">Setup</span>]</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StartupInMemoryApi</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    <span class="keyword">var</span> webHostBuilder = <span class="keyword">new</span> WebHostBuilder().UseStartupInstance(<span class="keyword">new</span> InMemoryStartup());</span><br><span class="line">    <span class="keyword">var</span> server = <span class="keyword">new</span> TestServer(webHostBuilder);</span><br><span class="line">    _httpClient = server.CreateClient();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  [<span class="meta">Test</span>]</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">TestGettingSomeData</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    <span class="keyword">var</span> response = <span class="keyword">await</span> _httpClient.GetAsync(<span class="string">"/some-data/123"</span>);</span><br><span class="line">    <span class="keyword">var</span> data = JsonConvert.DeserializeObject&lt;Data&gt;(<span class="keyword">await</span> response.Content.ReadAsStringAsync());</span><br><span class="line">    Assert.That(data.Id, Is.EqualTo(<span class="number">123</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  [<span class="meta">Test</span>]</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">TestPostingSomeData</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">      <span class="comment">//etc...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>As you can see this provides a simple method of testing an API inside your test harness. The HttpClient provides convenience methods for GET, POST, PUT PATCH and DELETE and also a general SendAsync method that allows for fine grained control. </p>
<p>What I’ve described here isn’t much more interesting or detailed than what is already described in similar posts. And like all of them so far we have skipped over an important detail; what about databases or any other external service on which I depend? If I simply replicate my application startup logic, I’m still pointing at a real database. This will prevent the tests from being repeatable and reliable as the external database is outside the control of the test harness.</p>
<p>To get around this we will need to design our InMemoryStartup class to inject Test Doubles (you might refer to them as Mocks, see <a href="https://martinfowler.com/bliki/TestDouble.html" target="_blank" rel="noopener">here</a> for definitions) into the application in place of your abstractions around your external dependencies (and I assume you are doing this right).</p>
<p>The place to do this is in the ConfigureServices method where we are setting up our dependency injection container with our dependencies. We would also want to be able to pass in our Test Doubles from our test harness so that the test can control these doubles and also read data from them. The InMemoryStartup class would end up looking something like this.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">InMemoryStartup</span> : <span class="title">IStartup</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> IDatabase _databaseTestDouble;</span><br><span class="line">    <span class="keyword">private</span> IClientApi _apiTestDouble;</span><br><span class="line">    <span class="keyword">private</span> ILog _logTestDouble;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InMemoryStartup</span>(<span class="params">IDatabase databaseTestDouble, IClientApi apiTestDouble, ILog logTestDouble</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _databaseTestDouble = databaseTestDouble;</span><br><span class="line">        _apiTestDouble = apiTestDouble;</span><br><span class="line">        _logTestDouble = logTestDouble;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IServiceProvider <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        services.AddSingleton&lt;IDatabase&gt;(_databaseTestDouble);</span><br><span class="line">        services.AddSingleton&lt;IClientApi&gt;(_apiTestDouble);</span><br><span class="line">        services.AddSingleton&lt;ILog&gt;(_logTestDouble);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Add other dependencies that are not external</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Some code to configure application</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Given this we can now modify our tests as follows…</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[<span class="meta">TextFixture</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SomeInMemoryTests</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> HttpClient _httpClient;</span><br><span class="line">  <span class="keyword">private</span> Data _testData;</span><br><span class="line"></span><br><span class="line">  [<span class="meta">Setup</span>]</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StatupInMemoryApi</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    _testData = Data() &#123;Id = <span class="number">123</span>, Data = <span class="string">"some data"</span>&#125;;</span><br><span class="line">    <span class="keyword">var</span> databaseDouble = <span class="keyword">new</span> FakeDatabase() &#123; Data = <span class="keyword">new</span> List&lt;Data&gt;()&#123;testData&#125;&#125;;</span><br><span class="line">    <span class="keyword">var</span> startUp = <span class="keyword">new</span> InMemoryStartup(databaseDouble, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">var</span> webHostBuilder = <span class="keyword">new</span> WebHostBuilder().UseStartupInstance(startUp);</span><br><span class="line">    <span class="keyword">var</span> server = <span class="keyword">new</span> TestServer(webHostBuilder);</span><br><span class="line">    _httpClient = server.CreateClient();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  [<span class="meta">Test</span>]</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">TestGettingSomeData</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    <span class="keyword">var</span> response = <span class="keyword">await</span> _httpClient.GetAsync(<span class="string">"/some-data/123"</span>);</span><br><span class="line">    <span class="keyword">var</span> data = JsonConvert.DeserializeObject&lt;Data&gt;(<span class="keyword">await</span> response.Content.ReadAsStringAsync());</span><br><span class="line">    Assert.That(data.Id, Is.EqualTo(_testData.Id));</span><br><span class="line">    Assert.That(data.Data, Is.EqualTo(_testData.Data));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In this particular example I have only supplied a test double for the database, in other tests you would want to provide doubles for the other dependencies as well. In fact I would suggest that you should set-up all of your dependencies for every test case and do so consistently for all tests. I would do this for the simple reason that you may suffer side effects when the different tests run in different setups of your API. </p>
<p>Given that it is advisable to set-up all of your dependencies for every tests it becomes obvious that you should encapsulate the setup of your dependencies in a class that you might call InMemoryApi. This could look something like this.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">InMemoryApi</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InMemoryApi</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        DatabaseTestDouble = <span class="keyword">new</span> FakeDatabase();</span><br><span class="line">        ClientApiTestDouble = <span class="keyword">new</span> FakeClientApi();</span><br><span class="line">        LoggerTestDouble = <span class="keyword">new</span> FakeLogger();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> startUp = <span class="keyword">new</span> InMemoryStartup(DatabaseTestDouble, ClientApiTestDouble, LoggerTestDouble);</span><br><span class="line">        <span class="keyword">var</span> webHostBuilder = <span class="keyword">new</span> WebHostBuilder().UseStartupInstance(startUp);</span><br><span class="line">        <span class="keyword">var</span> server = <span class="keyword">new</span> TestServer(webHostBuilder);</span><br><span class="line">        Client = server.CreateClient();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> FakeDatabase DatabaseTestDouble &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> FakeClientApi ClientApiTestDouble &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> FakeLogger LoggerTestDouble &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> HttpClient Client &#123;<span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Which then simplifies your test harness to look like this:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[<span class="meta">TextFixture</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SomeInMemoryTests</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> InMemoryApi _api;</span><br><span class="line">  <span class="keyword">private</span> Data _testData;</span><br><span class="line"></span><br><span class="line">  [<span class="meta">Setup</span>]</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StartupInMemoryApi</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    _testData = Data() &#123;Id = <span class="number">123</span>, Data = <span class="string">"some data"</span>&#125;;</span><br><span class="line">    _api = <span class="keyword">new</span> InMemoryApi();</span><br><span class="line">    _api.FakeDatabase.AddTestData(_testData); <span class="comment">//a method on your test double</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  [<span class="meta">Test</span>]</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">TestGettingSomeData</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    <span class="keyword">var</span> response = <span class="keyword">await</span> _api.Client.GetAsync(<span class="string">"/some-data/123"</span>);</span><br><span class="line">    <span class="keyword">var</span> data = JsonConvert.DeserializeObject&lt;Data&gt;(<span class="keyword">await</span> response.Content.ReadAsStringAsync());</span><br><span class="line">    Assert.That(data.Id, Is.EqualTo(_testData.Id));</span><br><span class="line">    Assert.That(data.Data, Is.EqualTo(_testData.Data));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You can now easily write further tests, reusing this InMemoryApi type with very little additional effort. All of your usual techniques for creating a common test context can be used to further reduce duplicate setup code. You can also use libraries such as <a href="http://nmock.sourceforge.net/" target="_blank" rel="noopener">NMock</a> or <a href="http://nsubstitute.github.io/" target="_blank" rel="noopener">NSubstitute</a> for creating your test doubles instead of hand-rolling them as is my preference. </p>
<p>You may at this point be thinking there is a risk of inconsistency between the API when it is running against your Startup class and your InMemoryStartup, as these both need to be very similar but also different enough to allow for testing. There are approaches to reduce this risk to a minimum which I plan to cover in a follow-up post as this one has already gone on for long enough.</p>
<p>I hope this was useful for you and had enough depth to get you started with this style of in memory API testing. </p>
</article><ul class="pager blog-pager"><li class="previous"><a href="/blog/2019/02/26/structuring-large-asp-net-projects-for-testing-and-readability/" data-toggle="tooltip" data-placement="top" title="Structuring large ASP.NET Core projects for testing and readability">← Previous Post</a></li><li class="next"><a href="/blog/2018/10/08/starting-your-career-as-a-software-developer/" data-toggle="tooltip" data-placement="top" title="Starting your career as a software developer">Next Post →</a></li></ul></div></div></div><footer><div class="container beautiful-jekyll-footer"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href="https://github.com/opentable" title="GitHub"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-github"></i></span></a></li><li><a href="https://twitter.com/opentabletechuk" title="Twitter"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-twitter"></i></span></a></li><li><a href="https://www.linkedin.com/company/12181" title="LinkedIn"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-linkedin"></i></span></a></li><li><a href="http://stackoverflow.com/jobs/companies/opentable" title="StackOverflow"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-stack-overflow"></i></span></a></li></ul><p class="copyright text-muted">© OpenTable • 2022 • <a href="mailto:undefined"></a>
</p><p class="theme-by text-muted">Theme by
<a href="https://github.com/twoyao/beautiful-hexo">beautiful-hexo</a></p></div></div></div></footer><script src="/js/jquery-1.11.2.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/main.js"></script><script src="/js/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script>(function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
    a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
})(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-2621903-16', 'auto');
ga('send', 'pageview');</script></body></html>